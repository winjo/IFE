!function(){function e(e,t){this.encode=e,this.decode=t}function t(e,t,n,s){setTimeout(function a(){Math.random()<t?(console.log("发送成功"),e(s)):(console.log("发送失败，尝试重新发送"),setTimeout(a,n))},n)}function n(){var e,t=120,n=Math.random()*Math.PI*2;return(e=l.pop())||(e=document.createElement("div")),e.id="airship"+ ++o,e.className="airship",e.setAttribute("r",t),e.setAttribute("rad",n),e.innerHTML='<div class="fuel"></div><span>'+o+'号-</span><span class="percent">100</span><span>%</span>',e.style.transform=s(t,n),document.getElementById("planet").appendChild(e),e}function s(e,t){var n=-Math.sin(t);return sin=Math.cos(t),"matrix("+n+","+sin+","+-sin+","+n+","+e*sin+","+-e*n+")"}function a(e){var t=u.adaper.decode(e);c.push(t),r(t)}function r(e){var t;y++,y<11?(t=document.createElement("tr"),h.appendChild(t),t.insertCell(0),t.cells[0].innerHTML=e.id,t.insertCell(1),t.cells[1].innerHTML=e.power,t.insertCell(2),t.cells[2].innerHTML=e.energy,t.insertCell(3),t.cells[3].innerHTML=e.status,t.insertCell(4),t.cells[4].innerHTML=e.fuel):(t=h.appendChild(h.firstElementChild),t.cells[0].innerHTML=e.id,t.cells[1].innerHTML=e.power,t.cells[2].innerHTML=e.energy,t.cells[3].innerHTML=e.status,t.cells[4].innerHTML=e.fuel)}function i(e,t){return(Array(t).join("0")+e).slice(-t)}var o=0,l=[],c=[],u=function(){var t={},n=[];return t.addAirship=function(e){n.push(e)},t.removeAirship=function(e){var t=n.indexOf(e);t>-1&&n.splice(t,1)},t.conduct=function(e){n.forEach(function(t){t.execute(e)})},t.adaper=new e(function(e){var t="";switch(t=i(e.id,4),e.command){case"fly":t+="0001";break;case"stop":t+="0010";break;case"destroy":t+="1100";break;default:t+="0000"}return t},function(e){var t={};switch(t.id=parseInt(e.slice(0,2),10)+"号",e.charAt(2)){case"0":t.power="前进号";break;case"1":t.power="奔腾好";break;case"2":t.power="超越号";break;default:t.power="unknown"}switch(e.charAt(3)){case"0":t.energy="劲量型";break;case"1":t.energy="光能型";break;case"2":t.energy="永久型";break;default:t.energy="unknown"}switch(e.slice(4,8)){case"0001":t.status="飞行中";break;case"0010":t.status="已停止";break;case"1100":t.status="即将销毁";break;default:t.status="unknown"}return t.fuel=parseInt(e.slice(-8),10)+"%",t}),t}(),d=function(e){this.element=n(),this.id=o,this.fuel=100,this.model=e,this.status="stop";var s=this,r=Date.now();requestAnimationFrame(function i(){var e=Date.now(),t=(e-r)*s.model.supply/1e3;s.setFuel(s.fuel+t),r=e,"destroy"!=s.status&&requestAnimationFrame(i)}),setTimeout(function l(){var e=s.adaper.encode(s);t(function(e){a(e)},.9,300,e),"destroy"!=s.status&&setTimeout(l,700)},1e3)};d.prototype.fly=function(){this.status="fly";var e=Date.now(),t=Date.now(),n=this.element.getAttribute("r"),a=this.element.getAttribute("rad"),r=this;requestAnimationFrame(function i(){var o=Date.now(),l=(o-e)*r.model.speed/1e3/n+Number(a),c=(o-t)*r.model.cosume/1e3;r.setFuel(r.fuel-c),r.element.style.transform=s(n,l),r.element.setAttribute("rad",l),"fly"==r.status&&r.fuel>0?(t=o,requestAnimationFrame(i)):"destroy"!=r.status&&(r.status="stop")})},d.prototype.stop=function(){this.status="stop"},d.prototype.destroy=function(){var e;e=this.element.parentNode.removeChild(this.element),l.push(e),this.status="destroy",u.removeAirship(this)},d.prototype.setFuel=function(e){e>100?this.fuel=100:e<0?this.fuel=0:this.fuel=e,this.element.firstElementChild.style.width=this.fuel+"%",this.element.getElementsByClassName("percent")[0].innerHTML=Math.floor(this.fuel)},d.prototype.execute=function(e){var n=300,s=.9,a=this;t(function(e){if(e=a.adaper.decode(e),console.log(a.id+"号飞船接受到命令"),a.id==e.id)switch(e.command){case"fly":console.log("飞船飞行"),a.fly();break;case"stop":console.log("飞船停止"),a.stop();break;case"destroy":console.log("飞船销毁"),a.destroy();break;default:console.log("无法识别命令")}},s,n,e)},d.prototype.adaper=new e(function(e){var t="";switch(t=i(e.id,2)+e.model.power+e.model.energy,e.status){case"fly":t+="0001";break;case"stop":t+="0010";break;case"destroy":t+="1100";break;default:t+="0000"}return t+=i(Math.floor(e.fuel),8)},function(e){var t={};switch(t.id=parseInt(e.slice(0,4),10),e.slice(4)){case"0001":t.command="fly";break;case"0010":t.command="stop";break;case"1100":t.command="destroy";break;default:t.command="unknown"}return t});var m=document.getElementById("conduct");m.addEventListener("click",function(e){var t=e.target;if("INPUT"==t.nodeName){var n={};n.id=t.parentNode.id-0,n.command=t.className,console.log("命令："+n.id+"号飞船"+t.value),u.conduct(u.adaper.encode(n))}},!1);var f=document.getElementById("create");f.addEventListener("click",function(){var e,t,n=document.getElementsByName("power"),s=document.getElementsByName("energy"),a={};e=Array.prototype.filter.call(n,function(e,t){if(e.checked)return a.power=t,!0})[0].value.split("/"),t=Array.prototype.filter.call(s,function(e,t){if(e.checked)return a.energy=t,!0})[0].value,a.speed=e[0]-0,a.cosume=e[1]-0,a.supply=t[0]-0,u.addAirship(new d(a)),console.log("新的飞船起飞")},!1);var p=document.getElementById("table-container"),h=p.firstElementChild.lastElementChild,y=0}(),function(){var e=16,t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(t){setTimeout(t,e)};window.requestAnimationFrame=t}();